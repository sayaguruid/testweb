<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Toko Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="bg-dark text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Admin Dashboard
                    </h1>
                </div>
                <div class="col-md-6 text-md-end">
                    <span class="me-3">
                        <i class="fas fa-user me-1"></i>
                        <span id="adminUsername"></span>
                    </span>
                    <button class="btn btn-danger btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt me-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-secondary py-2">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="btn-group" role="group">
                        <a href="admin-dashboard.html" class="btn btn-outline-light active">
                            <i class="fas fa-list me-1"></i>
                            Pesanan
                        </a>
                        <a href="admin-products.html" class="btn btn-outline-light">
                            <i class="fas fa-box me-1"></i>
                            Produk
                        </a>
                        <a href="index.html" class="btn btn-outline-light">
                            <i class="fas fa-home me-1"></i>
                            Toko
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container py-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalOrders">0</h4>
                                <p class="mb-0">Total Pesanan</p>
                            </div>
                            <div>
                                <i class="fas fa-shopping-cart fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="pendingOrders">0</h4>
                                <p class="mb-0">Pending</p>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="completedOrders">0</h4>
                                <p class="mb-0">Selesai</p>
                            </div>
                            <div>
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalRevenue">0</h4>
                                <p class="mb-0">Total Pendapatan</p>
                            </div>
                            <div>
                                <i class="fas fa-money-bill-wave fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="filterStatus" class="form-label">Filter Status</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">Semua Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Diproses">Diproses</option>
                                    <option value="Dikirim">Dikirim</option>
                                    <option value="Selesai">Selesai</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterPayment" class="form-label">Filter Pembayaran</label>
                                <select class="form-select" id="filterPayment">
                                    <option value="">Semua Pembayaran</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Dibayar">Dibayar</option>
                                    <option value="Gagal">Gagal</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="searchOrder" class="form-label">Cari Pesanan</label>
                                <input type="text" class="form-control" id="searchOrder" placeholder="Order ID, Nama, atau WhatsApp">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label><br>
                                <button class="btn btn-primary w-100" id="filterBtn">
                                    <i class="fas fa-filter me-1"></i>
                                    Filter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Daftar Pesanan
                </h5>
                <button class="btn btn-light btn-sm" id="refreshBtn">
                    <i class="fas fa-sync me-1"></i>
                    Refresh
                </button>
            </div>
            <div class="card-body">
                <!-- Loading -->
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Memuat data pesanan...</p>
                </div>

                <!-- Orders Table -->
                <div id="ordersTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Tanggal</th>
                                    <th>Nama</th>
                                    <th>WhatsApp</th>
                                    <th>Produk</th>
                                    <th>Total</th>
                                    <th>Bayar</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- No Orders -->
                <div id="noOrders" class="text-center py-5" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5>Belum ada pesanan</h5>
                    <p class="text-muted">Belum ada pesanan masuk saat ini.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Pesanan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailBody">
                    <!-- Order details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Status Pesanan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateStatusForm">
                        <input type="hidden" id="updateOrderId">
                        
                        <div class="mb-3">
                            <label for="updatePaymentStatus" class="form-label">Status Pembayaran</label>
                            <select class="form-select" id="updatePaymentStatus">
                                <option value="Pending">Pending</option>
                                <option value="Dibayar">Dibayar</option>
                                <option value="Gagal">Gagal</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="updateOrderStatus" class="form-label">Status Pesanan</label>
                            <select class="form-select" id="updateOrderStatus">
                                <option value="Pending">Pending</option>
                                <option value="Diproses">Diproses</option>
                                <option value="Dikirim">Dikirim</option>
                                <option value="Selesai">Selesai</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        let orders = [];
        let filteredOrders = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!isAdminLoggedIn()) {
                window.location.href = 'admin-login.html';
                return;
            }

            // Display admin username
            const username = localStorage.getItem('adminUsername') || sessionStorage.getItem('adminUsername');
            document.getElementById('adminUsername').textContent = username;

            // Load orders
            loadOrders();

            // Event listeners
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('refreshBtn').addEventListener('click', loadOrders);
            document.getElementById('filterBtn').addEventListener('click', filterOrders);
            document.getElementById('searchOrder').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') filterOrders();
            });
            document.getElementById('saveStatusBtn').addEventListener('click', saveStatus);
        });

        // Load orders from API
        async function loadOrders() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('ordersTable').style.display = 'none';
                document.getElementById('noOrders').style.display = 'none';

                const response = await fetch(`${API_BASE_URL}/admin/orders`, {
                    headers: {
                        'Authorization': `Bearer ${getAdminToken()}`
                    }
                });
                
                const result = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (result.success) {
                    orders = result.orders;
                    filteredOrders = [...orders];
                    displayOrders();
                    updateStatistics();
                } else {
                    showAlert(result.error || 'Gagal memuat pesanan', 'danger');
                }
                
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('loading').style.display = 'none';
                showAlert('Terjadi kesalahan. Silakan coba lagi.', 'danger');
            }
        }

        // Display orders in table
        function displayOrders() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (filteredOrders.length === 0) {
                document.getElementById('noOrders').style.display = 'block';
                document.getElementById('ordersTable').style.display = 'none';
                return;
            }
            
            tbody.innerHTML = '';
            
            filteredOrders.forEach(order => {
                const row = createOrderRow(order);
                tbody.appendChild(row);
            });
            
            document.getElementById('ordersTable').style.display = 'block';
            document.getElementById('noOrders').style.display = 'none';
        }

        // Create order row
        function createOrderRow(order) {
            const tr = document.createElement('tr');
            
            const paymentStatusClass = getPaymentStatusClass(order.payment_status);
            const orderStatusClass = getOrderStatusClass(order.order_status);
            
            tr.innerHTML = `
                <td><strong>${order.order_id}</strong></td>
                <td>${formatDate(order.date)}</td>
                <td>${order.name}</td>
                <td>${order.phone}</td>
                <td>${order.product_name}</td>
                <td>Rp ${formatNumber(order.total_price)}</td>
                <td><span class="badge ${paymentStatusClass}">${order.payment_status}</span></td>
                <td><span class="badge ${orderStatusClass}">${order.order_status}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="viewOrderDetail('${order.order_id}')" title="Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="updateOrderStatus('${order.order_id}')" title="Update Status">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${order.payment_proof ? `
                            <button class="btn btn-outline-success" onclick="viewPaymentProof('${order.order_id}')" title="Bukti Bayar">
                                <i class="fas fa-image"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            return tr;
        }

        // Filter orders
        function filterOrders() {
            const statusFilter = document.getElementById('filterStatus').value;
            const paymentFilter = document.getElementById('filterPayment').value;
            const searchTerm = document.getElementById('searchOrder').value.toLowerCase();
            
            filteredOrders = orders.filter(order => {
                const matchStatus = !statusFilter || order.order_status === statusFilter;
                const matchPayment = !paymentFilter || order.payment_status === paymentFilter;
                const matchSearch = !searchTerm || 
                    order.order_id.toLowerCase().includes(searchTerm) ||
                    order.name.toLowerCase().includes(searchTerm) ||
                    order.phone.toLowerCase().includes(searchTerm);
                
                return matchStatus && matchPayment && matchSearch;
            });
            
            displayOrders();
        }

        // Update statistics
        function updateStatistics() {
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(o => o.order_status === 'Pending').length;
            const completedOrders = orders.filter(o => o.order_status === 'Selesai').length;
            const totalRevenue = orders
                .filter(o => o.payment_status === 'Dibayar')
                .reduce((sum, o) => sum + o.total_price, 0);
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('completedOrders').textContent = completedOrders;
            document.getElementById('totalRevenue').textContent = formatNumber(totalRevenue);
        }

        // View order detail
        function viewOrderDetail(orderId) {
            const order = orders.find(o => o.order_id === orderId);
            if (!order) return;
            
            const modalBody = document.getElementById('orderDetailBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informasi Pesanan</h6>
                        <table class="table table-sm">
                            <tr><td>Order ID:</td><td><strong>${order.order_id}</strong></td></tr>
                            <tr><td>Tanggal:</td><td>${formatDate(order.date)}</td></tr>
                            <tr><td>Produk:</td><td>${order.product_name}</td></tr>
                            <tr><td>Jumlah:</td><td>${order.qty}</td></tr>
                            <tr><td>Total Harga:</td><td><strong>Rp ${formatNumber(order.total_price)}</strong></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Informasi Pelanggan</h6>
                        <table class="table table-sm">
                            <tr><td>Nama:</td><td>${order.name}</td></tr>
                            <tr><td>WhatsApp:</td><td>${order.phone}</td></tr>
                            <tr><td>Metode Bayar:</td><td>${order.payment_method}</td></tr>
                            <tr><td>Status Bayar:</td><td><span class="badge ${getPaymentStatusClass(order.payment_status)}">${order.payment_status}</span></td></tr>
                            <tr><td>Status Pesanan:</td><td><span class="badge ${getOrderStatusClass(order.order_status)}">${order.order_status}</span></td></tr>
                        </table>
                    </div>
                </div>
                ${order.note ? `
                    <div class="mt-3">
                        <h6>Catatan:</h6>
                        <p>${order.note}</p>
                    </div>
                ` : ''}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }

        // Update order status
        function updateOrderStatus(orderId) {
            const order = orders.find(o => o.order_id === orderId);
            if (!order) return;
            
            document.getElementById('updateOrderId').value = orderId;
            document.getElementById('updatePaymentStatus').value = order.payment_status;
            document.getElementById('updateOrderStatus').value = order.order_status;
            
            const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
            modal.show();
        }

        // Save status
        async function saveStatus() {
            const orderId = document.getElementById('updateOrderId').value;
            const paymentStatus = document.getElementById('updatePaymentStatus').value;
            const orderStatus = document.getElementById('updateOrderStatus').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/update-order-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAdminToken()}`
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        payment_status: paymentStatus,
                        order_status: orderStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Status berhasil diperbarui', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
                    loadOrders();
                } else {
                    showAlert(result.error || 'Gagal memperbarui status', 'danger');
                }
                
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('Terjadi kesalahan. Silakan coba lagi.', 'danger');
            }
        }

        // View payment proof
        function viewPaymentProof(orderId) {
            const order = orders.find(o => o.order_id === orderId);
            if (!order || !order.payment_proof) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bukti Pembayaran - ${orderId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${order.payment_proof}" alt="Bukti Pembayaran" class="img-fluid">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        // Logout
        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUsername');
            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminUsername');
            window.location.href = 'admin-login.html';
        }

        // Helper functions
        function getPaymentStatusClass(status) {
            const classMap = {
                'Pending': 'bg-warning',
                'Dibayar': 'bg-success',
                'Gagal': 'bg-danger'
            };
            return classMap[status] || 'bg-secondary';
        }

        function getOrderStatusClass(status) {
            const classMap = {
                'Pending': 'bg-warning',
                'Diproses': 'bg-primary',
                'Dikirim': 'bg-info',
                'Selesai': 'bg-success'
            };
            return classMap[status] || 'bg-secondary';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
